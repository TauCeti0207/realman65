# VR遥操作双臂机械臂控制系统说明文档

## 概述

本系统实现了基于VR头显（Quest）的双臂机械臂遥操作控制，支持实时位姿映射、夹爪控制和安全保护机制。系统采用模块化设计，包含VR数据接收、坐标转换、逆运动学求解和机械臂控制等核心功能。

## 系统架构

```
VR头显(Quest) 
    ↓ UDP通信
tiga_test_server.py (VR数据接收与处理)
    ↓ ROS2 TF + 控制器状态
vr_control_arm_unity_dual.py (遥操作控制器)
    ↓ 位姿映射与逆运动学
realman_65_interface_dual.py (机械臂接口)
    ↓ 关节控制
双臂机械臂硬件
```

## 核心模块

### 1. VR数据接收服务器 (`tiga_test_server.py`)

**功能：**
- 接收Quest头显的位姿和控制器数据
- 坐标系转换（Unity左手系 → ROS右手系）
- 发布TF变换和控制器状态
- 支持视频流传输（可选）

**关键端口配置：**
```python
data_receive_port = 8003     # 接收头显数据
status_send_port = 8004      # 发送状态数据
left_video_port = 8001       # 左眼视频流
right_video_port = 8002      # 右眼视频流
```

**发布的ROS话题：**
- `/device/trigger` - 扳机状态
- `/desire/twist` - 移动控制
- `quest/controller_state` - 控制器完整状态
- `save_frame2buffer_flag` - 录制标志

### 2. 遥操作控制器 (`vr_control_arm_unity_dual.py`)

**功能：**
- 订阅VR数据并进行位姿重定标
- 实现安全的遥操作开关机制
- 处理夹爪控制逻辑
- 提供紧急停止功能

**控制逻辑：**
- **左手扳机**：开启遥操作模式
- **右手扳机**：紧急停止并退出程序
- **左右食指扳机**：控制对应侧夹爪开合
- **摇杆**：控制机器人移动（可选）

### 3. 机械臂接口 (`realman_65_interface_dual.py`)

**功能：**
- 封装双臂机械臂控制接口
- 集成逆运动学求解器
- 提供线程安全的关节角控制
- 支持夹爪精确控制

## 使用指南

### 环境要求

**硬件：**
- Meta Quest VR头显
- 睿尔曼RM65双臂机械臂
- 局域网连接

**软件依赖：**
```bash
# ROS2相关
rclpy
tf2_ros
geometry_msgs
sensor_msgs
std_msgs

# 数学计算
numpy
scipy
cv2

# 机械臂SDK
Robotic_Arm (睿尔曼官方SDK)

# 其他
termcolor
json
threading
```

### 配置参数

#### 网络配置
```python
# VR头显IP地址
client_ip = "127.0.0.1"  # Quest设备IP

# 机械臂IP配置
DEFAULT_RM65_CONFIG = {
    'left_arm_ip': "192.168.1.18",   # 左臂IP
    'right_arm_ip': "192.168.2.19",  # 右臂IP
    'control_freq': 0.014285,        # 控制频率
}
```

#### 初始位置配置
```python
DEFAULT_JOINT_CONFIG = {
    'left_start_position': [0, 44, 114, 3, -66, 179],   # 左臂初始关节角
    'right_start_position': [0, 6, 52, -4, 88, -148],   # 右臂初始关节角
}
```

### 启动流程

#### 1. 启动VR数据服务器
```bash
cd realman65/teleop/
python3 tiga_test_server.py
```

#### 2. 启动遥操作控制
```bash
cd realman65/my_robot/
python3 vr_control_arm_unity_dual.py
```

#### 3. VR端操作
1. 戴上Quest头显，启动对应的Unity应用
2. 确保网络连接正常
3. 按下左手扳机开启遥操作模式
4. 直接移动和旋转控制器，机械臂会实时跟随控制器的位姿变化

### 操作说明

#### 基本控制
- **直接位姿映射**：移动VR控制器，对应侧机械臂末端实时跟随相同的位置和姿态变化
- **左手控制器** ↔ **左臂机械臂**：左手控制器的位置和姿态直接映射到左臂末端
- **右手控制器** ↔ **右臂机械臂**：右手控制器的位置和姿态直接映射到右臂末端
- **夹爪控制**：按下对应侧食指扳机控制夹爪开合

#### 安全机制
- **重定标机制**：首次操作时自动建立VR空间与机械臂工作空间的映射关系
- **遥操开关**：必须按下左手扳机才能开启控制，松开即停止
- **紧急停止**：按下右手扳机立即停止所有运动并退出程序
- **工作空间限制**：逆运动学求解失败时自动停止发送控制指令

#### 控制器按键映射
```
左控制器：
├── 控制器位姿 → 左臂机械臂末端位姿（直接映射）
├── 扳机(Hand Trigger) → 开启遥操作
└── 食指扳机(Index Trigger) → 左臂夹爪开合控制

右控制器：
├── 控制器位姿 → 右臂机械臂末端位姿（直接映射）
├── 扳机(Hand Trigger) → 紧急停止并退出程序
└── 食指扳机(Index Trigger) → 右臂夹爪开合控制
```

**注意**：按钮X/Y/A/B在VR数据服务器中有数据录制相关功能，但在遥操作控制中未使用。

## 技术细节

### 坐标系转换

VR使用Unity左手坐标系，机械臂使用ROS右手坐标系，需要进行转换：

```python
ADJ_MAT = np.array([
    [-1, 0,  0, 0],
    [0, -1,  0, 0], 
    [0, 0,  1, 0],
    [0, 0,  0, 1],
])
```

### 重定标算法

系统采用**一次性标定**的重定标方式，分别为左右臂独立计算偏移量：

#### 标定过程（仅在首次操作时执行一次）
1. **触发时机**：当遥操作开启且检测到VR控制器位姿数据时，如果对应侧尚未完成重定标
2. **偏移量计算**：
   ```python
   # 位置偏移：机械臂当前位置 - VR控制器当前位置
   pos_offset = robot_current_pos - vr_current_pos
   
   # 姿态偏移：VR控制器姿态的逆 × 机械臂当前姿态
   rot_offset = vr_current_rot.inv() * robot_current_rot
   ```

#### 实时映射过程（标定完成后持续执行）
```python
# 位置映射：VR位置 + 预计算的位置偏移
target_pos = vr_pos + pos_offset

# 姿态映射：VR姿态 × 预计算的姿态偏移
target_rot = vr_rot * rot_offset
```

#### 算法特点
- **双臂独立**：左右臂分别维护各自的偏移量，互不干扰
- **一次标定**：每侧机械臂只在首次检测到数据时计算一次偏移量
- **实时跟随**：标定完成后，机械臂末端实时跟随VR控制器的相对运动
- **坐标系适配**：自动处理VR空间与机械臂工作空间的尺度和原点差异

### 线程架构

```
主线程
├── ROS2 Executor线程 (处理订阅和TF)
├── VR数据处理线程 (60Hz)
├── 机械臂控制线程 (30Hz)
├── 左臂关节发送线程 (200Hz)
└── 右臂关节发送线程 (200Hz)
```

### 逆运动学求解

使用Pink库进行双臂协调的逆运动学求解：
```python
joint_target = dual_ik_solver.move_dual_arm(
    left_target_pos, left_target_quat,
    right_target_pos, right_target_quat
)
```

## 故障排除

### 常见问题

1. **VR连接失败**
   - 检查Quest设备IP配置
   - 确认防火墙设置
   - 验证UDP端口是否被占用

2. **机械臂无响应**
   - 检查机械臂IP地址和网络连接
   - 确认机械臂电源和急停状态
   - 查看控制器初始化日志

3. **位姿映射异常**
   - 重新进行重定标操作
   - 检查TF树是否正常发布
   - 验证坐标系转换矩阵

4. **夹爪控制失效**
   - 确认夹爪使能状态
   - 检查控制器按键映射
   - 查看夹爪状态反馈

### 调试工具

```bash
# 查看TF树
ros2 run tf2_tools view_frames

# 监控控制器状态
ros2 topic echo /quest/controller_state

# 查看机械臂状态
ros2 topic echo /device/trigger
```

## 扩展功能

### 录制与回放
系统支持操作录制功能，可保存VR操作序列用于后续回放分析。

### 视觉反馈
支持双目摄像头视频流传输，为操作者提供远程视觉反馈。

### 力反馈
预留接口支持触觉反馈设备集成。

## 安全注意事项

1. **工作空间安全**：确保机械臂工作范围内无人员和障碍物
2. **紧急停止**：操作前熟悉紧急停止按钮位置和操作方法
3. **网络安全**：在受控网络环境中使用，避免外部干扰
4. **设备检查**：定期检查VR设备和机械臂的硬件状态

## 维护与更新

- 定期更新VR应用和机械臂固件
- 检查网络延迟和控制精度
- 备份重要的配置参数和标定数据
- 记录操作日志用于问题追踪

---