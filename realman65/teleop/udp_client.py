import ast
import json
import socket
import time
import numpy as np
from scipy.spatial.transform import Rotation as R

input_json_string = """
{'timestamp': 1761276839641, \
'HPosition': {'x': 0.24114367365837097, 'y': -0.39944183826446533, 'z': 0.19797496497631073}, 
'HRotation': {'x': -0.30468907952308655, 'y': 0.3506386876106262, 'z': -0.5549319386482239, 'w': 0.6901215314865112}, 
'LPosition': {'x': 0.0, 'y': 0.0, 'z': 0.0}, 
'LRotation': {'x': -0.27059805393218994, 'y': -0.27059805393218994, 'z': -0.6532815098762512, 'w': 0.6532815098762512},
 'LThumbstick': {'x': 0.0, 'y': 0.0}, 'LIndexTrigger': 0.0, 'LHandTrigger': 0.0, 'LButtonOne': False, 'LButtonTwo': False, 
 'LButtonThumbstick': False, 'RPosition': {'x': 0.0, 'y': 0.0, 'z': 0.0}, 
 'RRotation': {'x': -0.27059805393218994, 'y': -0.27059805393218994, 'z': -0.6532815098762512, 'w': 0.6532815098762512}, 
 'RThumbstick': {'x': 0.0, 'y': 0.0}, 'RIndexTrigger': 0.0, 'RHandTrigger': 0.0, 'RButtonOne': False, 
 'RButtonTwo': False, 'RButtonThumbstick': False, 
 'LeftFingerPositions': [{'x': -0.020068995654582977, 'y': 0.011553998105227947, 'z': -0.010496998205780983}, {'x': -0.035958416759967804, 'y': 0.019157711416482925, 'z': -0.028028488159179688}, {'x': -0.0592186413705349, 'y': 0.03430762141942978, 'z': -0.044955700635910034}, {'x': -0.08312325179576874, 'y': 0.04371180385351181, 'z': -0.06691255420446396}, {'x': -0.09689630568027496, 'y': 0.051404375582933426, 'z': -0.0858159288764}, {'x': -0.09599620848894119, 'y': 0.007316453382372856, 'z': -0.023550672456622124}, {'x': -0.1337544023990631, 'y': 0.010550453327596188, 'z': -0.02202192135155201}, {'x': -0.1579199731349945, 'y': 0.012769035995006561, 'z': -0.020691605284810066}, {'x': -0.18003025650978088, 'y': 0.010573457926511765, 'z': -0.01793963834643364}, {'x': -0.09564658254384995, 'y': 0.002543153939768672, 'z': -0.0017259051091969013}, {'x': -0.13811546564102173, 'y': 0.0070214467123150826, 'z': 0.002640286460518837}, {'x': -0.16535551846027374, 'y': 0.009792775847017765, 'z': 0.005685922224074602}, {'x': -0.18986237049102783, 'y': 0.006591382436454296, 'z': 0.009400725364685059}, {'x': -0.088693767786026, 'y': 0.006529306061565876, 'z': 0.01746523566544056}, {'x': -0.12631435692310333, 'y': 0.010884799994528294, 'z': 0.026761068031191826}, {'x': -0.15188781917095184, 'y': 0.014168613590300083, 'z': 0.03319215774536133}, {'x': -0.17568819224834442, 'y': 0.014207775704562664, 'z': 0.038479238748550415}, {'x': -0.034073542803525925, 'y': 0.00941983237862587, 'z': 0.022998567670583725}, {'x': -0.07789582014083862, 'y': 0.013691176660358906, 'z': 0.0350540466606617}, {'x': -0.10740286111831665, 'y': 0.01811724528670311, 'z': 0.04236742481589317}, {'x': -0.1264030784368515, 'y': 0.0209718756377697, 'z': 0.04895481467247009}, {'x': -0.1476285755634308, 'y': 0.021193668246269226, 'z': 0.054572414606809616}, {'x': 0.0, 'y': 0.0, 'z': 0.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0}], 'LeftFingerRotations': [{'x': 0.37538713216781616, 'y': -0.42458415031433105, 'z': 0.007779002655297518, 'w': 0.8238642811775208}, {'x': 0.6271986365318298, 'y': -0.37717992067337036, 'z': 0.005259010940790176, 'w': 0.6814173460006714}, {'x': 0.5324819684028625, 'y': -0.37413716316223145, 'z': 0.0795641541481018, 'w': 0.7550854682922363}, {'x': 0.5750061869621277, 'y': -0.44487494230270386, 'z': 0.11960621178150177, 'w': 0.6761277914047241}, {'x': 0.5750062465667725, 'y': -0.4448748826980591, 'z': 0.11960622668266296, 'w': 0.6761278510093689}, {'x': 0.03068309649825096, 'y': 0.018855543807148933, 'z': -0.043281447142362595, 'w': 0.998413622379303}, {'x': 0.005106395110487938, 'y': 0.027173375710844994, 'z': -0.045847564935684204, 'w': 0.9985657930374146}, {'x': -0.00774027407169342, 'y': 0.05456734448671341, 'z': 0.026800023391842842, 'w': 0.9981204271316528}, {'x': -0.00774027407169342, 'y': 0.05456731468439102, 'z': 0.026800021529197693, 'w': 0.9981204271316528}, {'x': -0.00906632374972105, 'y': 0.051465608179569244, 'z': -0.05183575302362442, 'w': 0.9972874522209167}, {'x': -0.01993463560938835, 'y': 0.05642874911427498, 'z': -0.04932081699371338, 'w': 0.9969884157180786}, {'x': -0.04857669770717621, 'y': 0.06429474800825119, 'z': 0.04549427330493927, 'w': 0.995709240436554}, {'x': -0.04857669770717621, 'y': 0.0642947256565094, 'z': 0.04549427330493927, 'w': 0.995709240436554}, {'x': -0.05315937101840973, 'y': 0.12310334295034409, 'z': -0.049813494086265564, 'w': 0.9897162914276123}, {'x': -0.08697465062141418, 'y': 0.12716610729694366, 'z': -0.051409997045993805, 'w': 0.986722469329834}, {'x': -0.08865844458341599, 'y': 0.10063491016626358, 'z': -0.023695359006524086, 'w': 0.990682065486908}, {'x': -0.08865845203399658, 'y': 0.10063488781452179, 'z': -0.023695355281233788, 'w': 0.990682065486908}, {'x': -0.20703597366809845, 'y': 0.1403428465127945, 'z': -0.018311796709895134, 'w': 0.968041718006134}, {'x': -0.12191188335418701, 'y': 0.12826871871948242, 'z': -0.05740262195467949, 'w': 0.9825424551963806}, {'x': -0.15449336171150208, 'y': 0.17401543259620667, 'z': -0.044659413397312164, 'w': 0.9715225696563721}, {'x': -0.15165174007415771, 'y': 0.12966620922088623, 'z': -0.013773307204246521, 'w': 0.9797952771186829}, {'x': -0.15165174007415771, 'y': 0.12966623902320862, 'z': -0.013773303478956223, 'w': 0.9797952771186829}, {'x': 0.0, 'y': 0.0, 'z': 0.0, 'w': 1.0}, {'x': 4.3908708986727685e-17, 'y': 0.0, 'z': 0.0, 'w': 1.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0, 'w': 1.0}], 'RightFingerPositions': [{'x': 0.020068995654582977, 'y': -0.011553998105227947, 'z': 0.010496998205780983}, {'x': 0.035958416759967804, 'y': -0.019157707691192627, 'z': 0.028028488159179688}, {'x': 0.0592186413705349, 'y': -0.03430761769413948, 'z': 0.04495570808649063}, {'x': 0.08312325924634933, 'y': -0.04371180385351181, 'z': 0.06691255420446396}, {'x': 0.09689629822969437, 'y': -0.05140437185764313, 'z': 0.0858159288764}, {'x': 0.09599620848894119, 'y': -0.007316452916711569, 'z': 0.023550672456622124}, {'x': 0.1337544023990631, 'y': -0.010550454258918762, 'z': 0.02202192135155201}, {'x': 0.1579199731349945, 'y': -0.01276903785765171, 'z': 0.020691605284810066}, {'x': 0.18003025650978088, 'y': -0.010573459789156914, 'z': 0.01793963834643364}, {'x': 0.09564658254384995, 'y': -0.0025431537069380283, 'z': 0.0017259051091969013}, {'x': 0.13811546564102173, 'y': -0.007021446246653795, 'z': -0.002640286460518837}, {'x': 0.16535554826259613, 'y': -0.00979277677834034, 'z': -0.005685923621058464}, {'x': 0.18986240029335022, 'y': -0.006591381970793009, 'z': -0.00940072350203991}, {'x': 0.088693767786026, 'y': -0.006529305595904589, 'z': -0.01746523566544056}, {'x': 0.12631437182426453, 'y': -0.010884802788496017, 'z': -0.026761071756482124}, {'x': 0.15188783407211304, 'y': -0.014168616384267807, 'z': -0.03319215774536133}, {'x': 0.17568820714950562, 'y': -0.014207778498530388, 'z': -0.038479238748550415}, {'x': 0.034073542803525925, 'y': -0.009419831447303295, 'z': -0.022998567670583725}, {'x': 0.07789581269025803, 'y': -0.013691175729036331, 'z': -0.0350540429353714}, {'x': 0.10740286111831665, 'y': -0.01811724156141281, 'z': -0.042367421090602875}, {'x': 0.1264030784368515, 'y': -0.0209718756377697, 'z': -0.048954807221889496}, {'x': 0.1476285755634308, 'y': -0.021193666383624077, 'z': -0.05457241088151932}, {'x': 0.0, 'y': 0.0, 'z': 0.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0}], 'RightFingerRotations': [{'x': 0.37538713216781616, 'y': -0.42458415031433105, 'z': 0.007779002655297518, 'w': 0.8238642811775208}, {'x': 0.6271985173225403, 'y': -0.37717995047569275, 'z': 0.0052590202540159225, 'w': 0.6814174056053162}, {'x': 0.532481849193573, 'y': -0.3741372525691986, 'z': 0.07956412434577942, 'w': 0.7550855278968811}, {'x': 0.5750059485435486, 'y': -0.44487500190734863, 'z': 0.11960618942975998, 'w': 0.6761279106140137}, {'x': 0.5750060081481934, 'y': -0.44487500190734863, 'z': 0.11960618197917938, 'w': 0.6761279106140137}, {'x': 0.030683094635605812, 'y': 0.018855543807148933, 'z': -0.043281447142362595, 'w': 0.998413622379303}, {'x': 0.005106398835778236, 'y': 0.027173375710844994, 'z': -0.0458475686609745, 'w': 0.9985657930374146}, {'x': -0.007740268483757973, 'y': 0.05456733703613281, 'z': 0.026800014078617096, 'w': 0.9981204271316528}, {'x': -0.007740268483757973, 'y': 0.05456731468439102, 'z': 0.026800014078617096, 'w': 0.9981204271316528}, {'x': -0.0090663256123662, 'y': 0.051465608179569244, 'z': -0.05183575302362442, 'w': 0.9972874522209167}, {'x': -0.01993463560938835, 'y': 0.05642874911427498, 'z': -0.04932081699371338, 'w': 0.9969884157180786}, {'x': -0.04857669025659561, 'y': 0.06429474800825119, 'z': 0.04549427330493927, 'w': 0.995709240436554}, {'x': -0.048576682806015015, 'y': 0.0642947182059288, 'z': 0.04549427330493927, 'w': 0.995709240436554}, {'x': -0.05315936356782913, 'y': 0.12310334295034409, 'z': -0.049813494086265564, 'w': 0.9897162914276123}, {'x': -0.08697463572025299, 'y': 0.12716609239578247, 'z': -0.051409993320703506, 'w': 0.986722469329834}, {'x': -0.08865843713283539, 'y': 0.10063489526510239, 'z': -0.023695364594459534, 'w': 0.990682065486908}, {'x': -0.08865843713283539, 'y': 0.1006348729133606, 'z': -0.023695362731814384, 'w': 0.990682065486908}, {'x': -0.20703597366809845, 'y': 0.1403428465127945, 'z': -0.018311800435185432, 'w': 0.9680416584014893}, {'x': -0.1219119057059288, 'y': 0.12826871871948242, 'z': -0.05740262195467949, 'w': 0.9825423955917358}, {'x': -0.15449337661266327, 'y': 0.17401543259620667, 'z': -0.04465940594673157, 'w': 0.9715225100517273}, {'x': -0.15165174007415771, 'y': 0.12966620922088623, 'z': -0.013773294165730476, 'w': 0.9797952771186829}, {'x': -0.15165172517299652, 'y': 0.12966623902320862, 'z': -0.013773285783827305, 'w': 0.9797952771186829}, {'x': 0.0, 'y': 0.0, 'z': 0.0, 'w': 1.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0, 'w': 1.0}, {'x': 0.0, 'y': 0.0, 'z': 0.0, 'w': 1.0}]}
"""
TRANSFORM_TO_WORLD = np.ascontiguousarray(np.eye(4))
TRANSFORM_TO_WORLD[:3, :3] = R.from_euler('xyz', [-90, 0, -90], degrees=True).as_matrix()
WORLD_TO_TRANSFORM = np.ascontiguousarray(np.linalg.inv(TRANSFORM_TO_WORLD))

def convert_left_to_right_positions(left_pos):
    """
    将左坐标系下的位置向量转换为右坐标系下的位置向量
    参数:
        left_pos: 左坐标系下的位置向量 [x, y, z]
    返回:
        right_pos: 右坐标系下的位置向量 [x, y, z]
    """
    left_pos = [left_pos['x'], left_pos['y'], left_pos['z']]
    # 1. 首先进行左右坐标系的翻转（y坐标取反）
    x = left_pos[0]
    y = -left_pos[1]  # flip y from left to right
    z = left_pos[2]
    
    # 2. 应用世界坐标系变换
    # 将位置向量转换为齐次坐标形式（添加1作为最后一个元素）
    pos_homogeneous = np.array([x, y, z, 1.0])
    
    # 应用TRANSFORM_TO_WORLD变换
    transformed_pos = TRANSFORM_TO_WORLD @ pos_homogeneous
    
    # 提取前三个元素作为转换后的位置
    right_pos = transformed_pos[:3]
    
    return right_pos.tolist()

def convert_all_finger_positions(finger_data):
    """
    转换所有手指位置数据从左坐标系到右坐标系
    参数:
        finger_data: 包含左右手指位置数据的字典
    返回:
        转换后的手指位置数据字典
    """
    # 转换左手数据
    
    converted_left = [convert_left_to_right_positions(pos) for pos in finger_data["LeftFingerPositions"]]
    
    # 转换右手数据
    converted_right = [convert_left_to_right_positions(pos) for pos in finger_data["RightFingerPositions"]]
    
    return {
        "LeftFingerPositions": converted_left,
        "RightFingerPositions": converted_right
    }

def extract_and_repack_finger_positions(json_string):
    """
    接收一个包含追踪数据的JSON字符串，
    仅提取左右手的位置数据，并重新打包成一个新的JSON字符串。
    """
    try:
        # 1. 反序列化：将JSON字符串解析为Python字典
        full_data = json_string.copy()
        DESIRED_INDICES = [22,  1,   2,   3,   4,   5,   6,   7,   8,   9,   10,  
                           11,  12,  13,  14,  15,  16,  18,   19,  20,  21   ]
        max_index = max(DESIRED_INDICES)
        # 2. 提取需要的部分
        #    使用 .get() 是一个更安全的方法，如果键不存在，它会返回None或默认值
        left_positions = full_data.get('LeftFingerPositions', [])
        right_positions = full_data.get('RightFingerPositions', [])
        # print(len(left_positions))

        # 4. === 核心：使用列表推导式 (list comprehension) 按索引重新排序 ===
        reordered_left = [left_positions[i] for i in DESIRED_INDICES]
        reordered_right = [right_positions[i] for i in DESIRED_INDICES]
        print(len(reordered_left))

        # 3. 创建一个新的字典来打包数据
        packaged_data = {
            "LeftFingerPositions": reordered_left,
            "RightFingerPositions": reordered_right
        }
        
        converted_data = convert_all_finger_positions(packaged_data)
        
        # 4. 序列化：将新字典打包回JSON字符串
        #    indent=2 是为了让输出的JSON格式更易读
        output_json = json.dumps(converted_data, indent=2)
        
        return output_json
        
    except json.JSONDecodeError:
        print("错误: 无法解析JSON字符串")
        return None
    # except KeyError as e:
    #     # 如果你不用.get()而是用 data['Key']，则需要这个
    #     print(f"错误: 原始JSON中缺少键 {e}")
    #     return None


def udp_client():
    freq = 72
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    server_addr = ("localhost", 9999)

    try:
        while True:
            msg = extract_and_repack_finger_positions(input_json_string)
            sock.sendto(msg.encode(), server_addr)
            time.sleep(1 / freq)

    except:
        pass
    sock.close()

if __name__ == "__main__":
    udp_client()